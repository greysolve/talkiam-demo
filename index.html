<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Identity Management Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e1e5e9;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
        }
        
        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
            margin: 0 auto;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message {
            display: flex;
            gap: 8px;
            max-width: 70%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.assistant {
            align-self: flex-start;
        }
        
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .user .message-content {
            background: #007bff;
            color: white;
        }
        
        .assistant .message-content {
            background: #f1f3f4;
            color: #1f2937;
        }
        
        .status-message {
            align-self: center;
            background: #e7f3ff;
            color: #0066cc;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            margin: 8px 0;
        }
        
        .input-area {
            border-top: 1px solid #e1e5e9;
            padding: 16px 24px;
            background: white;
        }
        
        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            outline: none;
            min-height: 44px;
            max-height: 120px;
        }
        
        .input-field:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .send-button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background: #0056b3;
        }
        
        .send-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .quick-action {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action:hover {
            background: #e9ecef;
        }
        
        .success {
            color: #22c55e;
        }
        
        .warning {
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="status-dot"></div>
        <h1 id="orgName">Identity Management</h1>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
            <span id="userInfo" style="font-size: 14px; color: #6b7280;"></span>
            <button id="loginBtn" onclick="handleAuth()" style="background: #007bff; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                Sign In
            </button>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="messages" id="messages">
            <div class="message assistant">
                <div class="message-content">
                    üëã Hi! I'm here to help you manage user access and permissions for Acme Corp. You can ask me things like:
                    <br><br>
                    ‚Ä¢ "Add Sarah Jones from HR to the marketing tools"<br>
                    ‚Ä¢ "Remove Mike's access, he left the company"<br>
                    ‚Ä¢ "Who has admin access to QuickBooks?"<br>
                    ‚Ä¢ "Show me all inactive users"
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <div class="quick-actions">
                <div class="quick-action" onclick="setMessage('Who has admin access?')">üë• Show admins</div>
                <div class="quick-action" onclick="setMessage('Add new user')">‚ûï Add user</div>
                <div class="quick-action" onclick="setMessage('Run security audit')">üîç Security audit</div>
                <div class="quick-action" onclick="setMessage('Show me recent changes')">üìä Recent changes</div>
            </div>
            <div class="input-container">
                <textarea 
                    id="messageInput" 
                    class="input-field" 
                    placeholder="Ask me anything about user access and permissions..."
                    rows="1"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    ‚û§
                </button>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://your-project.supabase.co';  // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'your-anon-key-here';  // Replace with your anon key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const orgName = document.getElementById('orgName');

        let currentUser = null;

        // Check for existing session with Supabase
        async function initAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = {
                    email: session.user.email,
                    name: session.user.user_metadata?.name || session.user.email.split('@')[0],
                    company: session.user.user_metadata?.company || 'Demo Company',
                    id: session.user.id
                };
                updateUI();
                loadInitialMessage();
            } else {
                showLoginRequired();
            }
        }

        // Handle authentication
        async function handleAuth() {
            if (currentUser) {
                // Sign out
                await supabase.auth.signOut();
                currentUser = null;
                showLoginRequired();
            } else {
                // Show login form
                showLoginForm();
            }
        }

        function showLoginForm() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 32px; border-radius: 12px; width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <h2 style="margin: 0 0 8px 0; font-size: 24px;">Sign In to Demo</h2>
                    <p style="color: #6b7280; margin: 0 0 24px 0;">Experience the IAM platform</p>
                    
                    <input type="email" id="emailInput" placeholder="demo@company.com" value="demo@company.com" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    
                    <input type="password" id="passwordInput" placeholder="Password" value="demo123" style="width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                    
                    <button onclick="signInWithEmail()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Sign In
                    </button>
                    
                    <div style="text-align: center; margin: 16px 0; color: #9ca3af; position: relative;">
                        <span style="background: white; padding: 0 8px; position: relative; z-index: 1;">or</span>
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e5e7eb; z-index: 0;"></div>
                    </div>
                    
                    <button onclick="signInWithMagicLink()" style="width: 100%; padding: 12px; background: white; color: #007bff; border: 1px solid #007bff; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Send Magic Link
                    </button>
                    
                    <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; padding: 12px; margin-top: 8px; background: transparent; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle Enter key
            modal.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    signInWithEmail();
                }
            });
        }
        
        window.signInWithEmail = async function() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                alert('Login failed: ' + error.message);
            } else {
                document.querySelector('div[style*="position: fixed"]').remove();
                currentUser = {
                    email: data.user.email,
                    name: data.user.user_metadata?.name || data.user.email.split('@')[0],
                    company: data.user.user_metadata?.company || 'Demo Company',
                    id: data.user.id
                };
                updateUI();
                loadInitialMessage();
            }
        }
        
        window.signInWithMagicLink = async function() {
            const email = document.getElementById('emailInput').value;
            
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            const { error } = await supabase.auth.signInWithOtp({
                email: email,
                options: {
                    emailRedirectTo: window.location.origin
                }
            });
            
            if (error) {
                alert('Failed to send magic link: ' + error.message);
            } else {
                document.querySelector('div[style*="position: fixed"]').remove();
                messages.innerHTML = `
                    <div class="message assistant">
                        <div class="message-content">
                            ‚úÖ <strong>Magic link sent!</strong>
                            <br><br>
                            Check your email for the login link.
                        </div>
                    </div>
                `;
            }
        } white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Send Magic Link
                    </button>
                    
                    <button onclick="this.closest('div').parentElement.remove()" style="width: 100%; padding: 12px; margin-top: 8px; background: transparent; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('emailInput').focus();
            
            // Handle Enter key in email input
            document.getElementById('emailInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMagicLinkFromModal();
                }
            });
        }
        
        window.loginWithMicrosoft = async function() {
            // This would redirect to Microsoft OAuth2 flow
            // For now, we'll simulate it
            const msftUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
                `client_id=YOUR_CLIENT_ID&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(window.location.origin + '/callback')}&` +
                `scope=openid%20profile%20email%20User.Read&` +
                `state=${btoa(Date.now())}`;
            
            // In production, you'd redirect:
            // window.location.href = msftUrl;
            
            // For demo, simulate successful Microsoft login
            alert('Microsoft login would redirect to:\n' + msftUrl + '\n\n(Demo mode: simulating successful login)');
            document.querySelector('div[style*="position: fixed"]').remove();
            simulateLogin('user@company.com', 'Microsoft');
        }
        
        window.sendMagicLinkFromModal = function() {
            const email = document.getElementById('emailInput').value;
            if (!email || !email.includes('@')) {
                document.getElementById('emailInput').style.borderColor = '#ef4444';
                return;
            }
            document.querySelector('div[style*="position: fixed"]').remove();
            sendMagicLink(email);
        }

        async function sendMagicLink(email) {
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch('https://your-n8n-instance.com/webhook/send-magic-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        timestamp: new Date().toISOString(),
                        origin: window.location.origin
                    })
                });

                if (response.ok) {
                    // Show success message in the chat instead of alert
                    messages.innerHTML = `
                        <div class="message assistant">
                            <div class="message-content">
                                ‚úÖ <strong>Login link sent!</strong>
                                <br><br>
                                We've sent a secure login link to <strong>${email}</strong>
                                <br><br>
                                Please check your email and click the link to access your identity management system.
                                <br><br>
                                <small style="color: #6b7280;">Link expires in 15 minutes for security.</small>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error('Failed to send magic link');
                }
            } catch (error) {
                console.error('Magic link error:', error);
                messages.innerHTML = `
                    <div class="message assistant">
                        <div class="message-content">
                            ‚ùå <strong>Unable to send login link</strong>
                            <br><br>
                            Please check your email address and try again, or contact your IT administrator.
                        </div>
                    </div>
                `;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        // Handle magic link login (from URL parameter)
        async function handleMagicLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            const org = urlParams.get('org');

            if (token && email) {
                // Show validating message
                messages.innerHTML = `
                    <div class="status-message">
                        üîê Validating your login token...
                    </div>
                `;
                
                try {
                    // Validate token with backend
                    const response = await fetch('https://your-n8n-instance.com/webhook/validate-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: token,
                            email: email
                        })
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        
                        // Store validated user data
                        currentUser = {
                            email: email,
                            name: userData.name || email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            company: userData.company || org || email.split('@')[1].split('.')[0].toUpperCase(),
                            token: token,
                            roles: userData.roles || ['user'],
                            expiresAt: new Date(Date.now() + 3600000).toISOString() // 1 hour
                        };
                        
                        sessionStorage.setItem('iam_user', JSON.stringify(currentUser));
                        updateUI();
                        loadInitialMessage();
                        
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        throw new Error('Invalid or expired token');
                    }
                } catch (error) {
                    console.error('Token validation error:', error);
                    messages.innerHTML = `
                        <div class="message assistant">
                            <div class="message-content">
                                ‚ùå <strong>Login link expired or invalid</strong>
                                <br><br>
                                Please request a new login link to continue.
                            </div>
                        </div>
                    `;
                    // Clean up URL anyway
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }
        
        // Check token expiration
        function isTokenValid() {
            if (!currentUser || !currentUser.expiresAt) return false;
            return new Date(currentUser.expiresAt) > new Date();
        }
        
        // Simulate login (for demo purposes)
        function simulateLogin(email, method = 'Magic Link') {
            const name = email.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const company = email.split('@')[1].split('.')[0].replace(/\b\w/g, l => l.toUpperCase());
            
            currentUser = {
                email: email,
                name: name,
                company: company,
                initials: name.split(' ').map(n => n[0]).join('').toUpperCase(),
                token: btoa(email + Date.now()),
                authMethod: method,
                roles: ['user', 'admin'], // Mock roles
                expiresAt: new Date(Date.now() + 3600000).toISOString() // 1 hour
            };

            sessionStorage.setItem('iam_user', JSON.stringify(currentUser));
            updateUI();
            showWelcomeMessage(method);
        }
        
        function showWelcomeMessage(authMethod) {
            messages.innerHTML = `
                <div class="status-message" style="background: #d4f4dd; color: #166534;">
                    ‚úÖ Successfully authenticated via ${authMethod}
                </div>
                <div class="message assistant">
                    <div class="message-content">
                        üëã Welcome back, <strong>${currentUser.name}</strong>!
                        <br><br>
                        You're now connected to the ${currentUser.company} Identity Management System.
                        <br><br>
                        Your access level: <span style="background: #e7f3ff; padding: 2px 6px; border-radius: 4px;">${currentUser.roles.includes('admin') ? 'üëë Administrator' : 'üë§ User'}</span>
                        <br><br>
                        How can I help you manage access and permissions today?
                    </div>
                </div>
            `;
        }

        function updateUI() {
            if (currentUser) {
                userInfo.textContent = `${currentUser.name} (${currentUser.company})`;
                orgName.textContent = `${currentUser.company} - Identity Management`;
                loginBtn.textContent = 'Sign Out';
                
                // Enable chat
                messageInput.disabled = false;
                sendButton.disabled = false;
            }
        }

        function showLoginRequired() {
            userInfo.textContent = '';
            orgName.textContent = 'Identity Management';
            loginBtn.textContent = 'Sign In';
            
            // Disable chat and show login message
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            messages.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        üîê Please sign in with your work email to access your organization's identity management system.
                        <br><br>
                        We'll send you a secure login link - no passwords required!
                    </div>
                </div>
            `;
        }

        function loadInitialMessage() {
            messages.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        üëã Hi ${currentUser.name}! I'm here to help you manage user access and permissions for ${currentUser.company}. You can ask me things like:
                        <br><br>
                        ‚Ä¢ "Add Sarah Jones from HR to the marketing tools"<br>
                        ‚Ä¢ "Remove Mike's access, he left the company"<br>
                        ‚Ä¢ "Who has admin access to QuickBooks?"<br>
                        ‚Ä¢ "Show me all inactive users"
                    </div>
                </div>
            `;
        }

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send on Enter (but not Shift+Enter)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function setMessage(text) {
            messageInput.value = text;
            messageInput.focus();
        }

        function addMessage(content, isUser = false, isStatus = false) {
            const messageDiv = document.createElement('div');
            
            if (isStatus) {
                messageDiv.className = 'status-message';
                messageDiv.innerHTML = content;
            } else {
                messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
                messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            }
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        // Define getAccessToken function (placeholder for now)
        async function getAccessToken() {
            // This would normally get a real Microsoft Graph access token
            // For now, return the stored token or a demo token
            if (currentUser && currentUser.token) {
                return currentUser.token;
            }
            return 'demo-access-token';
        }

        async function sendMessage() {
            if (!currentUser) {
                alert('Please sign in first');
                return;
            }

            const content = messageInput.value.trim();
            if (!content) return;

            // Add user message
            addMessage(content, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            sendButton.disabled = true;
            addMessage('‚ö° Processing request...', false, true);

            try {
                const token = await getAccessToken();
                
                // Call your n8n webhook endpoint with auth info
                const response = await fetch('https://your-n8n-instance.com/webhook/iam-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Pass the token for verification
                    },
                    body: JSON.stringify({
                        message: content,
                        user_id: currentUser.email,
                        user_name: currentUser.name,
                        company: currentUser.company,
                        timestamp: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                
                // Remove typing indicator
                messages.removeChild(messages.lastChild);
                
                // Add AI response
                addMessage(data.response || data.message, false);
                
            } catch (error) {
                // Remove typing indicator
                messages.removeChild(messages.lastChild);
                
                // Show error message
                addMessage('‚ùå Sorry, I encountered an error processing your request. Please try again or contact support.', false);
                console.error('Chat error:', error);
            }
            
            sendButton.disabled = false;
            messageInput.focus();
        }

        // Initialize authentication on page load
        handleMagicLink();
        initAuth();
    </script>
</body>
</html>